# ADR-005: Autenticação e Autorização

## Status
Aprovado

## Contexto
Apesar do desafio não solicitar, entende-se que o sistema proposto precisa 
de autenticação segura com controle de acesso por perfil (ex: operador vs 
administrador). A solução deve ser robusta, open source, containerizável e 
integrar-se naturalmente com .NET 10 via padrões abertos (OAuth 2.0 + OpenID
 Connect).

Além da autenticação funcional, o campo `created_by` de cada evento no
Event Store (vide [ADR-003](https://github.com/alexandredorea/Challenge.CRM.Rommanel/blob/master/docs/ADR-003.md)) 
deve ser preenchido automaticamente com a identidade do usuário autenticado, 
garantindo rastreabilidade completa na auditoria.

## Opções Consideradas

| Opção              | Prós                                              | Contras                                          |
|--------------------|---------------------------------------------------|--------------------------------------------------|
| Keycloak           | IAM completo, OAuth2/OIDC, open source, container | Requer configuração inicial de realm/client      |
| ASP.NET Identity   | Nativo ao ecossistema .NET                        | Gerenciamento de usuários no próprio serviço     |
| Auth0              | SaaS gerenciado, fácil setup                      | Custo em produção, dependência de terceiro       |

## Decisão
Keycloak como servidor de identidade externo, executando como container
no `docker-compose`. O backend .NET 10 valida os JWTs emitidos pelo Keycloak
via middleware `AddJwtBearer` com validação automática via JWKS endpoint.

## Fluxo de Autenticação

Frontend
- Redireciona para Keycloak (Authorization Code Flow + PKCE)
- Usuário autentica no Keycloak
- Recebe Access Token (JWT assinado)
- Envia token no header: Authorization: Bearer <token>

Backend
- Valida assinatura do JWT via JWKS do Keycloak
- Extrai claims: sub (ID do usuário), email, roles
- claim "sub" → preenchimento automático do campo created_by nos eventos


## Consequências
- Autenticação e gerenciamento de usuários totalmente delegados ao Keycloak
- Nenhuma senha ou hash de senha no código da aplicação
- O `created_by` em cada evento vem do token — auditabilidade garantida
- Keycloak sobe junto com os demais serviços via `docker-compose up`
- Perfis e permissões configuráveis no painel do Keycloak sem alterar código
